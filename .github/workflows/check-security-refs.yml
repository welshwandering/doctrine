# Security Reference Staleness Check
#
# Runs monthly to detect outdated security references and creates an issue
# when updates are needed. Prevents the situation we encountered where
# multiple references became significantly outdated.
#
# References checked:
# - MITRE ATT&CK (via GitHub API)
# - MITRE ATLAS (via GitHub API)
# - CWE Top 25 (annual, via MITRE CWE site)
# - OWASP Top 10 (periodic, via OWASP site)
# - SLSA (via GitHub API)

name: Check Security References

on:
  schedule:
    # Monthly on the 1st at midnight UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read current manifest
        id: manifest
        run: |
          echo "mitre_attack=$(jq -r '.sources.mitre_attack.version' reference/security/manifest.json)" >> $GITHUB_OUTPUT
          echo "mitre_atlas=$(jq -r '.sources.mitre_atlas.version' reference/security/manifest.json)" >> $GITHUB_OUTPUT
          echo "slsa=$(jq -r '.sources.slsa.version' reference/security/manifest.json)" >> $GITHUB_OUTPUT
          echo "cwe=$(jq -r '.sources.cwe.version' reference/security/manifest.json)" >> $GITHUB_OUTPUT
          echo "owasp_web=$(jq -r '.sources.owasp_top10.versions.web' reference/security/manifest.json)" >> $GITHUB_OUTPUT

      - name: Check MITRE ATT&CK latest
        id: attack
        run: |
          LATEST=$(curl -s https://api.github.com/repos/mitre/cti/releases/latest | jq -r '.tag_name' | sed 's/ATT&CK-v//')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          if [ "${{ steps.manifest.outputs.mitre_attack }}" != "$LATEST" ]; then
            echo "outdated=true" >> $GITHUB_OUTPUT
          fi

      - name: Check MITRE ATLAS latest
        id: atlas
        run: |
          LATEST=$(curl -s https://api.github.com/repos/mitre-atlas/atlas-data/releases/latest | jq -r '.tag_name' | sed 's/v//')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          if [ "${{ steps.manifest.outputs.mitre_atlas }}" != "$LATEST" ]; then
            echo "outdated=true" >> $GITHUB_OUTPUT
          fi

      - name: Check SLSA latest
        id: slsa
        run: |
          LATEST=$(curl -s https://api.github.com/repos/slsa-framework/slsa/releases/latest | jq -r '.tag_name' | sed 's/v//')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          if [ "${{ steps.manifest.outputs.slsa }}" != "$LATEST" ]; then
            echo "outdated=true" >> $GITHUB_OUTPUT
          fi

      - name: Calculate staleness
        id: staleness
        run: |
          UPDATES_NEEDED=""

          if [ "${{ steps.attack.outputs.outdated }}" == "true" ]; then
            UPDATES_NEEDED="${UPDATES_NEEDED}- **MITRE ATT&CK**: ${{ steps.manifest.outputs.mitre_attack }} â†’ ${{ steps.attack.outputs.latest }}\n"
          fi

          if [ "${{ steps.atlas.outputs.outdated }}" == "true" ]; then
            UPDATES_NEEDED="${UPDATES_NEEDED}- **MITRE ATLAS**: ${{ steps.manifest.outputs.mitre_atlas }} â†’ ${{ steps.atlas.outputs.latest }}\n"
          fi

          if [ "${{ steps.slsa.outputs.outdated }}" == "true" ]; then
            UPDATES_NEEDED="${UPDATES_NEEDED}- **SLSA**: ${{ steps.manifest.outputs.slsa }} â†’ ${{ steps.slsa.outputs.latest }}\n"
          fi

          if [ -n "$UPDATES_NEEDED" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "updates<<EOF" >> $GITHUB_OUTPUT
            echo -e "$UPDATES_NEEDED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if updates needed
        if: steps.staleness.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”„ Security References Need Updates';
            const body = `## Outdated Security References Detected

            The following security references in \`reference/security/\` are outdated:

            ${{ steps.staleness.outputs.updates }}

            ### Manual Checks Needed
            - [ ] CWE Top 25 (check https://cwe.mitre.org/top25/)
            - [ ] OWASP Top 10 Web (check https://owasp.org/Top10/)
            - [ ] OWASP Top 10 API (check https://owasp.org/API-Security/)
            - [ ] OWASP Top 10 LLM (check https://owasp.org/www-project-top-10-for-large-language-model-applications/)

            ### How to Update
            1. Update the JSON files in \`reference/security/\`
            2. Update version numbers in \`reference/security/manifest.json\`
            3. Update cross-references in related files

            See \`manifest.json\` for file locations and update URLs.

            ---
            *This issue was automatically created by the security reference staleness check.*`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security-refs',
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security-refs', 'maintenance']
              });
            }
