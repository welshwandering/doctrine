# Doctrine Config Sync
#
# This workflow syncs Claude Code configs from Doctrine to your project.
# Copy this file to your project's .github/workflows/ directory.
#
# Usage:
#   1. Copy this file to your project
#   2. Set DOCTRINE_SYNC_TOKEN secret (PAT with repo scope)
#   3. Customize SYNC_PATHS below
#   4. Run manually or wait for weekly schedule

name: Sync Doctrine Configs

on:
  schedule:
    # Weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Preview changes without creating PR'
        required: false
        default: 'false'
        type: boolean

env:
  DOCTRINE_REPO: welshwandering/doctrine
  DOCTRINE_BRANCH: main
  # Customize these paths for your project
  SYNC_PATHS: |
    configs/claude/settings.json:.claude/settings.json
    configs/claude/agents:.claude/agents
    configs/claude/commands:.claude/commands

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout project
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Checkout Doctrine
        uses: actions/checkout@v6
        with:
          repository: ${{ env.DOCTRINE_REPO }}
          ref: ${{ env.DOCTRINE_BRANCH }}
          path: .doctrine-upstream

      - name: Sync configs
        id: sync
        run: |
          changes=false

          # Parse SYNC_PATHS (source:dest format)
          while IFS= read -r mapping; do
            [ -z "$mapping" ] && continue

            src="${mapping%%:*}"
            dest="${mapping##*:}"

            src_path=".doctrine-upstream/$src"

            if [ ! -e "$src_path" ]; then
              echo "Warning: Source not found: $src_path"
              continue
            fi

            # Create destination directory
            mkdir -p "$(dirname "$dest")"

            # Copy file or directory
            if [ -d "$src_path" ]; then
              # Directory: sync contents
              mkdir -p "$dest"
              if ! diff -rq "$src_path" "$dest" > /dev/null 2>&1; then
                cp -r "$src_path"/* "$dest/"
                changes=true
                echo "Updated: $dest/"
              fi
            else
              # File: copy if different
              if ! diff -q "$src_path" "$dest" > /dev/null 2>&1; then
                cp "$src_path" "$dest"
                changes=true
                echo "Updated: $dest"
              fi
            fi
          done <<< "$SYNC_PATHS"

          echo "changes=$changes" >> $GITHUB_OUTPUT

          # Cleanup
          rm -rf .doctrine-upstream

      - name: Get Doctrine version
        if: steps.sync.outputs.changes == 'true'
        id: version
        run: |
          version=$(cat .doctrine-upstream/VERSION 2>/dev/null || echo "unknown")
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.sync.outputs.changes == 'true' && inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync Claude configs from Doctrine ${{ steps.version.outputs.version }}"
          title: "chore: sync Claude configs from Doctrine"
          body: |
            ## Doctrine Config Sync

            This PR updates Claude Code configurations from [Doctrine](https://github.com/${{ env.DOCTRINE_REPO }}).

            ### Changes

            - Synced from Doctrine version: `${{ steps.version.outputs.version }}`
            - Source: `${{ env.DOCTRINE_REPO }}@${{ env.DOCTRINE_BRANCH }}`

            ### Review Checklist

            - [ ] Review updated configs for project-specific overrides
            - [ ] Test Claude Code with new configurations
            - [ ] Verify hooks and permissions are appropriate

            ---

            ðŸ¤– This PR was automatically created by the [Doctrine Sync workflow](.github/workflows/sync-doctrine.yml).
          branch: chore/sync-doctrine
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Dry run summary
        if: inputs.dry_run == 'true'
        run: |
          echo "## Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.sync.outputs.changes }}" == "true" ]; then
            echo "Changes detected. A PR would be created." >> $GITHUB_STEP_SUMMARY
            git diff --stat
          else
            echo "No changes detected." >> $GITHUB_STEP_SUMMARY
          fi
